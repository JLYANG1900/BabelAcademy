<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>巴别塔日报 - 状态栏 (The Babel Daily)</title>

  <!-- 引入复古风格字体 -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@400;700;900&family=Playfair+Display:ital,wght@0,400;0,700;1,400;1,700&family=Six+Caps&family=UnifrakturMaguntia&display=swap"
    rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@300;400;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Ma+Shan+Zheng&display=swap" rel="stylesheet">

  <style>
    /* =========================================
       THEME: NEWSPAPER (Day & Night)
       ========================================= */
    :root {
      /* Default (Light/Day) */
      --paper-bg: #f0e6d2;
      --paper-bg-contrast: #fffdf5;
      /* 用于仪表盘背景 */
      --ink-black: #1a1a1a;
      --ink-gray: #4a4a4a;
      --ink-red: #8b0000;

      --border-thick: 4px solid var(--ink-black);
      --border-thin: 1px solid var(--ink-black);
      --border-double: 4px double var(--ink-black);

      --gauge-track: #ddd;
      --manifest-bg: linear-gradient(to bottom, #f2f2f2 0%, #d4d4d4 50%, #aaaaaa 51%, #e0e0e0 100%);
      --manifest-text: #333;
      --manifest-shadow: 1px 1px 2px rgba(0, 0, 0, 0.4), inset 1px 1px 0 rgba(255, 255, 255, 0.8);

      /* Typography */
      --font-masthead: 'Cinzel Decorative', cursive;
      --font-headline: 'Playfair Display', serif;
      --font-body: 'Source Han Serif SC', '思源宋体', 'Noto Serif SC', serif;
      --font-meta: 'Six Caps', 'Noto Serif SC', sans-serif;
      --font-gothic: 'UnifrakturMaguntia', cursive;
      --font-calligraphy: 'Ma Shan Zheng', cursive;
    }

    /* Dark Mode (Night Edition) Overrides */
    [data-theme="dark"] {
      --paper-bg: #1c1a17;
      /* 深咖啡/沥青色 */
      --paper-bg-contrast: #2a2622;
      --ink-black: #d6cfc2;
      /* 羊皮纸白 */
      --ink-gray: #968e80;
      /* 灰褐色 */
      --ink-red: #ff5a5a;
      /* 提亮的红色 */

      --border-thick: 4px solid var(--ink-black);
      --border-thin: 1px solid var(--ink-black);
      --border-double: 4px double var(--ink-black);

      --gauge-track: #3d3834;
      /* 物品栏在夜间变为深色金属质感 */
      --manifest-bg: linear-gradient(to bottom, #4a4a4a 0%, #2b2b2b 50%, #1a1a1a 51%, #2b2b2b 100%);
      --manifest-text: #e0e0e0;
      --manifest-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8), inset 1px 1px 0 rgba(255, 255, 255, 0.1);
    }

    /* =========================================
       BASE
       ========================================= */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: var(--font-body);
      background-color: transparent;
      color: var(--ink-black);
      padding: 10px;
      line-height: 1.4;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 0;
      height: auto;
      /* Smooth theme transition */
      transition: color 0.5s ease;
    }

    /* =========================================
       FOLDED STATE
       ========================================= */
    #scroll-seal {
      cursor: pointer;
      text-align: center;
      transition: transform 0.3s ease;
      margin: 10px 0;
      z-index: 100;
      display: block;
      opacity: 1;
    }

    #scroll-seal:hover {
      transform: scale(1.02);
    }

    .newspaper-stack {
      width: 260px;
      padding: 15px;
      background: var(--paper-bg);
      border: 1px solid var(--ink-gray);
      position: relative;
      text-align: center;
      /* Stack shadow logic needs to update with JS or be subtle enough */
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
      transition: background 0.5s ease;
    }

    .stack-lines {
      border-top: 2px solid var(--ink-black);
      border-bottom: 1px solid var(--ink-black);
      margin: 5px 0;
      padding: 5px 0;
    }

    .stack-label {
      font-family: var(--font-gothic);
      font-size: 2.2rem;
      color: var(--ink-black);
      line-height: 1;
      display: block;
    }

    .stack-sub {
      font-family: var(--font-meta);
      font-size: 1rem;
      text-transform: uppercase;
      letter-spacing: 2px;
      color: var(--ink-gray);
      margin-top: 4px;
      display: block;
      font-weight: bold;
    }

    /* =========================================
       MAIN NEWSPAPER CONTAINER
       ========================================= */
    .status-container {
      max-width: 1100px;
      width: 100%;
      background-color: var(--paper-bg);
      /* Noise texture overlay */
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.08'/%3E%3C/svg%3E");

      padding: 0;
      box-shadow: 0 15px 30px rgba(0, 0, 0, 0.4);

      opacity: 0;
      max-height: 0;
      overflow: hidden;
      transform-origin: top center;
      transition: all 0.6s cubic-bezier(0.25, 1, 0.5, 1), background-color 0.5s ease;

      display: flex;
      flex-direction: column;
      margin-top: 0;
    }

    .status-container.open {
      opacity: 1;
      max-height: 10000px;
      margin-top: 10px;
      margin-bottom: 50px;
    }

    /* =========================================
       MASTHEAD
       ========================================= */
    .masthead {
      text-align: center;
      padding: 20px 20px 10px 20px;
      border-bottom: var(--border-thick);
      position: relative;
    }

    .masthead-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: var(--border-thin);
      margin-bottom: 10px;
      font-family: var(--font-meta);
      font-size: 1.2rem;
      text-transform: uppercase;
      padding-bottom: 4px;
    }

    /* THEME TOGGLE BUTTON */
    #theme-toggle {
      cursor: pointer;
      font-weight: bold;
      border: 1px solid transparent;
      padding: 0 8px;
      transition: all 0.2s;
    }

    #theme-toggle:hover {
      border: 1px solid var(--ink-black);
      background: rgba(125, 125, 125, 0.1);
    }

    .paper-title {
      font-family: var(--font-masthead);
      font-size: 3.5rem;
      font-weight: 900;
      line-height: 1;
      color: var(--ink-black);
      text-transform: uppercase;
      margin: 10px 0;
      text-shadow: 2px 2px 0 rgba(0, 0, 0, 0.1);
      cursor: pointer;
    }

    .paper-subtitle {
      font-family: var(--font-headline);
      font-style: italic;
      font-size: 1.2rem;
      color: var(--ink-gray);
      margin-bottom: 15px;
    }

    .dateline {
      display: flex;
      justify-content: space-between;
      border-top: var(--border-double);
      border-bottom: var(--border-double);
      padding: 8px 0;
      font-family: var(--font-meta);
      font-size: 1.4rem;
      text-transform: uppercase;
      letter-spacing: 1px;
      background: rgba(0, 0, 0, 0.02);
    }

    .dateline-item {
      padding: 0 20px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .weather-icon {
      width: 20px;
      height: 20px;
      fill: var(--ink-black);
      transition: fill 0.5s ease;
    }

    /* =========================================
       PAPER BODY (LAYOUT)
       ========================================= */
    .paper-body {
      display: flex;
      flex-direction: column;
      width: 100%;
    }

    .column-header {
      font-family: var(--font-meta);
      font-size: 2rem;
      line-height: 1;
      border-bottom: var(--border-thick);
      margin-bottom: 15px;
      text-transform: uppercase;
      letter-spacing: 2px;
      padding-bottom: 5px;
      width: 100%;
    }

    /* =========================================
       SECTION 1: PERSONAL FILE
       ========================================= */
    .personal-section {
      padding: 20px;
      background-color: rgba(0, 0, 0, 0.02);
      border-bottom: var(--border-double);
    }

    .personal-dashboard {
      display: grid;
      grid-template-columns: 1fr 1.5fr 1fr;
      gap: 20px;
      align-items: start;
    }

    .personal-col {
      padding: 0 10px;
    }

    .personal-col.bordered {
      border-right: 1px dashed var(--ink-gray);
    }

    .player-card {
      margin-bottom: 0;
    }

    .data-row {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      border-bottom: 1px dotted var(--ink-gray);
      padding: 8px 0;
    }

    .data-label {
      font-family: var(--font-body);
      font-weight: bold;
      color: var(--ink-gray);
      font-size: 0.95rem;
    }

    .data-value {
      font-family: var(--font-headline);
      font-weight: 700;
      font-size: 1.1rem;
    }

    /* Gauges */
    .gauge-box {
      margin-top: 0;
      border: 1px solid var(--ink-black);
      padding: 10px;
      background: var(--paper-bg-contrast);
      height: 100%;
      display: flex;
      flex-direction: column;
      justify-content: center;
      transition: background 0.5s ease;
    }

    .gauge-title {
      font-family: var(--font-meta);
      font-size: 1.2rem;
      text-align: center;
      border-bottom: 1px solid var(--ink-black);
      margin-bottom: 8px;
      padding-bottom: 2px;
    }

    .gauge-row {
      display: flex;
      align-items: center;
      margin-bottom: 8px;
    }

    .gauge-row:last-child {
      margin-bottom: 0;
    }

    .gauge-label {
      width: 85px;
      font-size: 1.05rem;
      font-family: var(--font-calligraphy);
      font-weight: normal;
      line-height: 1.1;
    }

    .gauge-track {
      flex-grow: 1;
      height: 8px;
      background: var(--gauge-track);
      border: 1px solid var(--ink-black);
      position: relative;
    }

    .gauge-fill {
      height: 100%;
      background: var(--ink-black);
      background-image: repeating-linear-gradient(45deg, transparent, transparent 3px, rgba(255, 255, 255, 0.3) 3px, rgba(255, 255, 255, 0.3) 6px);
    }

    .gauge-val {
      width: 30px;
      text-align: right;
      font-size: 0.9rem;
      font-family: var(--font-meta);
    }

    .gauge-fill.society {
      background-color: var(--ink-red);
    }

    .gauge-fill.suspicion {
      background-color: var(--ink-gray);
    }

    /* Inventory */
    .manifest-box {
      margin-top: 0;
      border: 2px solid var(--ink-black);
      padding: 5px;
      height: 100%;
      background: var(--paper-bg-contrast);
      transition: background 0.5s ease;
    }

    .manifest-header {
      background: var(--ink-black);
      color: var(--paper-bg);
      text-align: center;
      font-family: var(--font-meta);
      font-size: 1.2rem;
      padding: 4px;
      margin-bottom: 5px;
    }

    .manifest-content {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
    }

    .manifest-item {
      border: 1px solid #7a7a7a;
      padding: 4px 10px;
      font-size: 0.9rem;
      font-weight: bold;
      background: var(--manifest-bg);
      color: var(--manifest-text);
      text-shadow: var(--manifest-shadow);
      box-shadow: 1px 1px 2px rgba(0, 0, 0, 0.4), inset 1px 1px 0 rgba(255, 255, 255, 0.2);
      font-family: var(--font-meta);
      letter-spacing: 1px;
      border-radius: 1px;
      transform: skewX(-5deg);
    }

    /* =========================================
       SECTION 2: SOCIETY
       ========================================= */
    .society-section {
      padding: 20px;
    }

    .society-lead {
      font-family: var(--font-headline);
      font-size: 1.8rem;
      font-weight: 700;
      margin-bottom: 10px;
      line-height: 1.1;
    }

    .society-intro {
      font-size: 1rem;
      font-style: italic;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid var(--ink-black);
      column-span: all;
    }

    .npc-columns {
      column-count: 2;
      column-gap: 20px;
      column-rule: 1px solid var(--ink-gray);
    }

    .npc-entry {
      break-inside: avoid;
      margin-bottom: 20px;
      border-bottom: 1px solid var(--ink-gray);
      padding-bottom: 15px;
      display: flex;
      /* 改为Flex布局以支持头像 */
      gap: 15px;
      align-items: flex-start;
    }

    /* 新增头像样式 */
    .npc-mugshot-container {
      flex-shrink: 0;
      width: 70px;
      height: 70px;
      border: 3px solid var(--ink-black);
      padding: 2px;
      background: var(--paper-bg-contrast);
      margin-top: 4px;
      box-shadow: 3px 3px 0 rgba(0, 0, 0, 0.2);
      transform: rotate(-1deg);
    }

    .npc-mugshot {
      width: 100%;
      height: 100%;
      object-fit: cover;
      /* 报纸风格滤镜 */
      filter: sepia(0.3) contrast(1.1);
      transition: filter 0.3s ease;
    }

    .npc-mugshot:hover {
      filter: none;
      /* 悬停时显示原色 */
    }

    .npc-info-col {
      flex-grow: 1;
    }

    .npc-headline {
      font-family: var(--font-calligraphy);
      font-size: 1.5rem;
      font-weight: normal;
      margin-bottom: 0px;
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      line-height: 1.2;
    }

    .love-sticker {
      display: inline-block;
      background-color: var(--ink-red);
      color: #fff;
      font-family: var(--font-meta);
      font-size: 0.9rem;
      font-weight: normal;
      padding: 1px 6px;
      margin-left: 8px;
      transform: rotate(-3deg);
      box-shadow: 2px 2px 0px rgba(0, 0, 0, 0.2);
      border: 1px dashed rgba(255, 255, 255, 0.4);
      letter-spacing: 1px;
    }

    .npc-subhead {
      font-family: var(--font-calligraphy);
      font-size: 1.1rem;
      color: var(--ink-gray);
      margin-bottom: 8px;
    }

    .npc-status-line {
      font-size: 0.9rem;
      margin-bottom: 4px;
      display: flex;
    }

    .npc-status-line strong {
      margin-right: 6px;
      text-transform: uppercase;
      font-size: 0.8rem;
      letter-spacing: 1px;
    }

    .quote-box {
      margin-top: 8px;
      padding: 8px;
      background: rgba(128, 128, 128, 0.1);
      border-left: 3px solid var(--ink-black);
      font-family: 'Playfair Display', serif;
      font-style: italic;
      font-size: 0.9rem;
    }

    #npc-trigger-btn {
      width: 100%;
      text-align: center;
      padding: 10px;
      background: var(--ink-black);
      color: var(--paper-bg);
      font-family: var(--font-meta);
      font-size: 1.2rem;
      text-transform: uppercase;
      cursor: pointer;
      margin-top: 10px;
      transition: background 0.3s;
    }

    #npc-trigger-btn:hover {
      background: var(--ink-red);
    }

    /* Responsive */
    @media (max-width: 768px) {
      .personal-dashboard {
        grid-template-columns: 1fr;
        gap: 20px;
      }

      .personal-col.bordered {
        border-right: none;
        border-bottom: 1px dashed var(--ink-gray);
        padding-bottom: 15px;
        margin-bottom: 15px;
      }

      .npc-columns {
        column-count: 1;
      }

      .paper-title {
        font-size: 2.5rem;
      }

      .dateline {
        flex-wrap: wrap;
        font-size: 1rem;
      }
    }
  </style>
</head>

<body>

  <!-- 1. The Rolled Newspaper Stack -->
  <div id="scroll-seal" onclick="openScroll()">
    <div class="newspaper-stack">
      <div class="stack-lines">
        <span class="stack-label">The Babel Daily</span>
        <span class="stack-sub" id="stack-sub-info">Latest Edition</span>
      </div>
    </div>
  </div>

  <!-- 2. The Main Newspaper Container -->
  <div class="status-container" id="status-container">

    <!-- MASTHEAD -->
    <header class="masthead">
      <div class="masthead-top">
        <span>Vol. XCII No. 14,208</span>
        <!-- Theme Toggle Button -->
        <span id="theme-toggle" onclick="toggleTheme()">☾ Night Edition</span>
        <span>Price: 5 Coppers</span>
      </div>
      <div class="paper-title" onclick="closeScroll()">The Babel Daily</div>
      <div class="paper-subtitle">An act of translation is always an act of betrayal.</div>

      <!-- Dateline Strip -->
      <div class="dateline">
        <div class="dateline-item">
          <svg class="weather-icon" viewBox="0 0 24 24">
            <path
              d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.11 0-1.99.9-1.99 2L3 20a2 2 0 0 0 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V10h14v10z" />
          </svg>
          <span id="current-time">---</span>
        </div>
        <div class="dateline-item"
          style="flex:1; justify-content:center; border-left:1px solid var(--ink-black); border-right:1px solid var(--ink-black);">
          <span id="location">---</span>
        </div>
        <div class="dateline-item">
          <svg class="weather-icon" viewBox="0 0 24 24">
            <path
              d="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96z" />
          </svg>
          <span id="weather">---</span>
        </div>
      </div>
    </header>

    <!-- PAPER BODY -->
    <div class="paper-body">

      <!-- SECTION 1: PERSONAL FILE -->
      <section class="personal-section">
        <div class="column-header">Personal File</div>

        <div class="personal-dashboard">

          <!-- Column 1: Stats -->
          <div class="personal-col bordered">
            <div class="player-card">
              <div class="data-row">
                <span class="data-label">年级 / Grade</span>
                <span class="data-value" id="grade">---</span>
              </div>
              <div class="data-row">
                <span class="data-label">银币 / Assets</span>
                <span class="data-value"><span id="silver-coins">0</span> ¤</span>
              </div>
              <div class="data-row" style="flex-direction:column; align-items:flex-start; margin-top:10px;">
                <span class="data-label">衣着 / Attire</span>
                <span class="data-value" id="clothing"
                  style="font-weight:400; font-size:1rem; margin-top:4px;">---</span>
              </div>
            </div>
          </div>

          <!-- Column 2: Gauges -->
          <div class="personal-col bordered">
            <div class="gauge-box">
              <div class="gauge-title">Standing</div>

              <div class="gauge-row">
                <div class="gauge-label">对帝国贡献</div>
                <div class="gauge-track">
                  <div class="gauge-fill" id="empire-bar" style="width:0%"></div>
                </div>
                <div class="gauge-val" id="empire-contrib">0</div>
              </div>

              <div class="gauge-row">
                <div class="gauge-label">对社团贡献</div>
                <div class="gauge-track">
                  <div class="gauge-fill society" id="society-bar" style="width:0%"></div>
                </div>
                <div class="gauge-val" id="society-contrib">0</div>
              </div>

              <div class="gauge-row">
                <div class="gauge-label">嫌疑</div>
                <div class="gauge-track">
                  <div class="gauge-fill suspicion" id="suspicion-bar" style="width:0%"></div>
                </div>
                <div class="gauge-val" id="suspicion">0</div>
              </div>
            </div>
          </div>

          <!-- Column 3: Inventory -->
          <div class="personal-col">
            <div class="manifest-box">
              <div class="manifest-header">Your Magic</div>
              <div class="manifest-content" id="inventory">
                <span style="font-style:italic; font-size:0.8rem;">(Empty)</span>
              </div>
            </div>
          </div>

        </div>
      </section>

      <!-- SECTION 2: SOCIETY -->
      <section class="society-section">
        <div class="column-header">Society & Rumors <span id="sync-status"
            style="font-size:0.8rem; float:right; margin-top:8px;">Printing...</span></div>

        <div class="society-lead">Who's in the Tower?</div>
        <p class="society-intro">
          Latest reports from the academy halls. Observations recorded by anonymous sources.
        </p>

        <!-- NPC Grid -->
        <div id="lower-deck" style="max-height: 400px; overflow: hidden; transition: max-height 0.8s ease;">
          <div class="npc-columns" id="npc-grid">
            <!-- NPC Content -->
          </div>
        </div>

        <div id="npc-trigger-btn" onclick="toggleNPCs()">Read Full Section ▼</div>
      </section>

    </div>
  </div>

  <script type="module">
    // ═══════════════════════════════════════════════════════════════════════════
    // UI INTERACTIONS (Theme & Folding)
    // ═══════════════════════════════════════════════════════════════════════════

    // Toggle Dark/Light Mode
    window.toggleTheme = function () {
      const html = document.documentElement;
      const btn = document.getElementById('theme-toggle');
      const current = html.getAttribute('data-theme');

      if (current === 'dark') {
        html.removeAttribute('data-theme');
        btn.innerHTML = '☾ Night Edition';
      } else {
        html.setAttribute('data-theme', 'dark');
        btn.innerHTML = '☀ Day Edition';
      }
    }

    window.openScroll = function () {
      const scrollSeal = document.getElementById('scroll-seal');
      const container = document.getElementById('status-container');

      scrollSeal.style.opacity = '0';
      setTimeout(() => {
        scrollSeal.style.display = 'none';
        container.classList.add('open');
      }, 300);
    }

    window.closeScroll = function () {
      const scrollSeal = document.getElementById('scroll-seal');
      const container = document.getElementById('status-container');

      container.classList.remove('open');
      setTimeout(() => {
        scrollSeal.style.display = 'block';
        requestAnimationFrame(() => {
          scrollSeal.style.opacity = '1';
        });
      }, 600);
    }

    window.toggleNPCs = function () {
      const lowerDeck = document.getElementById('lower-deck');
      const btn = document.getElementById('npc-trigger-btn');

      if (lowerDeck.style.maxHeight === '400px') {
        lowerDeck.style.maxHeight = '5000px';
        btn.innerHTML = 'Collapse Section ▲';
      } else {
        lowerDeck.style.maxHeight = '400px';
        btn.innerHTML = 'Read Full Section ▼';
      }
    }

    // ═══════════════════════════════════════════════════════════════════════════
    // DATA LOGIC
    // ═══════════════════════════════════════════════════════════════════════════
    const NPC_CONFIG = [
      { id: '威廉诺曼', name: '威廉·诺曼', identity: '诺曼家族家主/教授', varKey: '威廉·诺曼', currentKey: '威廉诺曼', avatar: 'https://i.ibb.co/j9GvLhc6/image.png' },
      { id: '埃莉诺诺曼', name: '埃莉诺·诺曼', identity: '诺曼家族成员/同学', varKey: '埃莉诺·诺曼', currentKey: '埃莉诺诺曼', avatar: 'https://i.ibb.co/XxmhT3hd/image.png' },
      { id: '海因里希', name: '海因里希', identity: '普鲁士贵族/同学', varKey: '海因里希·冯·克莱斯特', currentKey: '海因里希冯克莱斯特', avatar: 'https://i.ibb.co/8nd5P5jL/image.png' },
      { id: '关祁', name: '关祁', identity: '大清八旗子弟/同学', varKey: '关祁', currentKey: '关祁', avatar: 'https://i.ibb.co/N6dhQqK9/image.png' },
      { id: '源结月', name: '源结月', identity: '日本源氏后裔/同学', varKey: '源结月', currentKey: '源结月', avatar: 'https://i.ibb.co/0R2bkTck/image.png' },
      { id: '索菲亚', name: '索菲亚', identity: '沙俄流亡贵族/同学', varKey: '索菲亚·奥博连斯基', currentKey: '索菲亚奥博连斯基', avatar: 'https://i.ibb.co/BV8qYXQm/image.png' },
      { id: '佩德罗', name: '佩德罗', identity: '巴西糖业商人/同学', varKey: '佩德罗·德索萨', currentKey: '佩德罗德索萨', avatar: 'https://i.ibb.co/BHTSV0bT/image.png' },
      { id: '科莱特', name: '科莱特', identity: '法国贵族/教授', varKey: '科莱特·瓦卢瓦', currentKey: '科莱特瓦卢瓦', avatar: 'https://i.ibb.co/yFqz4n1v/image.png' }
    ];

    function safeGet(obj, path, defaultValue = '---') {
      const keys = Array.isArray(path) ? path : path.split('.');
      let current = obj;
      for (const key of keys) {
        if (current === undefined || current === null || typeof current !== 'object') {
          return defaultValue;
        }
        current = current[key];
      }
      return current ?? defaultValue;
    }

    async function populateStatusBar() {
      const syncStatus = document.getElementById('sync-status');

      try {
        const allVars = typeof getAllVariables === 'function' ? getAllVariables() : {};
        const data = allVars?.stat_data;

        if (!data) {
          syncStatus.textContent = 'NO DATA';
          syncStatus.style.color = 'var(--ink-red)';
          return;
        }

        syncStatus.textContent = 'LATEST';

        // World Info Data
        const timeVal = safeGet(data, '世界.当前时间') + ' ' + safeGet(data, '世界.当前时段');
        const weatherVal = safeGet(data, '世界.当前天气');
        const locationVal = safeGet(data, '世界.当前地点');
        const locUpper = locationVal.toUpperCase();

        document.getElementById('current-time').textContent = timeVal;
        document.getElementById('weather').textContent = weatherVal;
        document.getElementById('location').textContent = locUpper;

        // Stack Info
        const stackInfo = document.getElementById('stack-sub-info');
        if (stackInfo) {
          stackInfo.textContent = `${timeVal} • ${locUpper}`;
        }

        // Player Info
        document.getElementById('clothing').textContent = safeGet(data, '玩家.衣着');
        document.getElementById('grade').textContent = safeGet(data, '玩家.年级');
        document.getElementById('silver-coins').textContent = safeGet(data, '玩家.银币', 0);

        const empireContrib = Number(safeGet(data, '玩家.帝国贡献', 0));
        document.getElementById('empire-contrib').textContent = empireContrib;
        document.getElementById('empire-bar').style.width = empireContrib + '%';

        const societyContrib = Number(safeGet(data, '玩家.社团贡献', 0));
        document.getElementById('society-contrib').textContent = societyContrib;
        document.getElementById('society-bar').style.width = societyContrib + '%';

        const suspicion = Number(safeGet(data, '玩家.怀疑度', 0));
        document.getElementById('suspicion').textContent = suspicion;
        document.getElementById('suspicion-bar').style.width = suspicion + '%';

        // Inventory
        const inventory = safeGet(data, '玩家.银条背包', []);
        const invEl = document.getElementById('inventory');
        if (Array.isArray(inventory) && inventory.length > 0) {
          invEl.innerHTML = inventory.map(item => `<span class="manifest-item">${item}</span>`).join('');
        } else {
          invEl.innerHTML = '<span style="font-style:italic; font-size:0.8rem;">(No Items Declared)</span>';
        }

        // NPC News Columns
        const currentChars = safeGet(data, '主要角色', {});
        const npcGridEl = document.getElementById('npc-grid');

        let npcHtml = '';
        for (const npc of NPC_CONFIG) {
          const charData = currentChars[npc.currentKey] || {};
          const love = Number(charData['好感度'] ?? 0);
          const location = charData['位置'] || 'Unknown';
          const clothing = charData['当前穿着'] || '---';
          const action = charData['当前状态'] || '---';
          const thought = charData['当前想法'] || '---';

          npcHtml += `
          <div class="npc-entry">
            <div class="npc-mugshot-container">
              <img src="${npc.avatar}" class="npc-mugshot" alt="${npc.name}" onerror="this.style.display='none'">
            </div>
            <div class="npc-info-col">
              <div class="npc-headline">
                ${npc.name} 
                <span class="love-sticker">LOVE: ${love}%</span>
              </div>
              <div class="npc-subhead">${npc.identity}</div>
              
              <div class="npc-status-line"><strong>Seen At:</strong> ${location}</div>
              <div class="npc-status-line"><strong>Wearing:</strong> ${clothing}</div>
              <div class="npc-status-line"><strong>Activity:</strong> ${action}</div>
              
              <div class="quote-box">
                 “${thought}”
              </div>
            </div>
          </div>
        `;
        }
        npcGridEl.innerHTML = npcHtml;

      } catch (error) {
        syncStatus.textContent = 'ERROR';
        console.error('[状态栏] 加载失败:', error);
      }
    }

    async function init() {
      if (typeof waitGlobalInitialized === 'function') {
        await waitGlobalInitialized('Mvu');
      }
      populateStatusBar();
    }

    if (typeof errorCatched === 'function' && typeof $ !== 'undefined') {
      $(errorCatched(init));
    } else {
      init();
    }
  </script>
</body>

</html>